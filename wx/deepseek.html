<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>─=≡Σ((( つ•̀ω•́)つ</title>
<style>
/* 基础样式 */
* { box-sizing: border-box; }
body {
  font-family: Arial, sans-serif;
  margin: 0; padding: 0;
  background-color: #f4f4f9; color: #333;
  min-height: 100vh; display: flex; justify-content: center; align-items: center;
}
.container {
  background: #fff; padding: 20px; width: 100%; height: 100%;
  max-width: 980px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
  border-radius: 8px; text-align: center; overflow-y: auto;
}
h1 { color: #4CAF50; margin-bottom: 20px; }

/* 输入与按钮 */
textarea {
  width: 100%; min-height: 180px; margin-bottom: 10px;
  border: 1px solid #ccc; border-radius: 4px; padding: 10px;
  font-size: 14px; resize: vertical;
}
.button {
  background-color: #4CAF50; color: white; border: none;
  padding: 7px 12px; margin: 5px; border-radius: 4px; cursor: pointer;
  transition: background-color 0.3s ease; white-space: nowrap; font-size: 12px;
}
.button[disabled]{ opacity:.6; cursor:not-allowed; }
.button:hover { background-color: #45a049; }
.button-group, .input-group, .button-container {
  display: flex; flex-wrap: nowrap; justify-content: space-around;
  overflow-x: auto; margin-bottom: 12px; gap: 6px;
}
input[type="file"], input[type="number"], input[type="text"]{
  padding: 10px; margin-bottom: 12px;
  border-radius: 4px; border: 1px solid #ccc; width: 100%;
}

/* 拖拽区 */
#dropZone{
  border: 1px dashed #bbb; border-radius: 6px; padding: 10px; margin-bottom: 12px;
  color:#666; font-size:12px;
}
#dropZone.dragover{ border-color:#4CAF50; color:#4CAF50; background:#f6fff6; }

/* 输出媒体样式 */
.output img, .output audio, .output video, #displayedImage {
  max-width: 100%; max-height: 420px; margin-top: 10px;
}
#imageDisplayContainer { display: none; margin-bottom: 10px; }
.image-time { margin-top: 5px; font-size: 0.85em; color: #666; }
.edit-buttons { display: none; margin-top: 12px; }
.edit-buttons .button { margin: 5px; }

/* 统计栏 */
#stats {
  display: flex; justify-content: space-around; align-items: center;
  font-size: 10px; color: #333; margin: 12px 0;
  padding: 10px; background-color: #eee; border-radius: 5px;
}
#stats div { margin: 0 5px; white-space: nowrap; }

/* 响应区 */
#responseWrap { display:none; text-align:left; }
#response {
  white-space: pre-wrap; text-align: left; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  background:#0b1020; color:#cbe4ff; border-radius:6px; padding:10px; font-size:12px; max-height: 280px; overflow:auto;
}
#respBar{ display:flex; gap:8px; align-items:center; margin-bottom:6px; }
#respStatus{ font-size:12px; color:#666; }

/* 底部 banner */
.footer{ margin-top: 10px; }
</style>
</head>
<body>
<div class="container">

  <!-- 顶部：文件+帧率 -->
  <input type="file" id="fileInput" accept="image/*,audio/*,video/*" />
  <input type="number" id="intervalInput" value="" min="1" placeholder="1秒查看几帧：帧率 (仅视频)" />

  <!-- 文件功能 -->
  <div class="button-group">
    <button class="button" id="btnToB64">文件转码</button>
    <button class="button" id="btnFromB64">码转文件</button>
    <button class="button" id="btnFrames">视频帧</button>
    <button class="button" id="btnClearOutput">清空文件</button>
  </div>

  <!-- 文本编辑 -->
  <textarea id="textarea" placeholder="输入文本或粘贴 Base64 数据。"></textarea>

  <!-- 文本按钮 -->
  <div class="input-group" id="textGroup">
    <button class="button" id="copy-btn">复制文本</button>
    <button class="button" id="remove-duplicates-btn">去重复行</button>
    <button class="button" id="openkey-btn" data-api-url="https://api.poixe.com/v1/chat/completions">测试文本</button>
    <button class="button" id="clear-btn">清空文本</button>
  </div>

  <!-- API 响应 -->
  <div id="responseWrap">
    <div id="respBar">
      <span id="respStatus">准备就绪</span>
      <button class="button" id="btnCopyResp">复制响应</button>
      <button class="button" id="btnHideResp">收起</button>
    </div>
    <div id="response">等待请求...</div>
  </div>

  <!-- 统计 -->
  <div id="stats">
    <div id="total">总数：0</div>
    <div id="chinese">汉字：0</div>
    <div id="punctuation">标点：0</div>
    <div id="alphabet">字母：0</div>
    <div id="numbers">数字：0</div>
    <div id="duplicate">重复：0</div>
  </div>

  <!-- 图片/帧展示 -->
  <div style="text-align:center; margin-top:1px; padding: 0 2px;">
    <div id="imageDisplayContainer">
      <img id="displayedImage" src="" alt="Extracted Frame" />
      <div id="imageTimeLabel" class="image-time"></div>
      <div class="button-container">
        <button class="button" id="prevButton">上帧 (←)</button>
        <button class="button" id="btnDownloadFrame">下载当前帧</button>
        <button class="button" id="nextButton">下帧 (→)</button>
      </div>
      <div class="image-time" id="framePager">0 / 0</div>
    </div>
    <div class="edit-buttons" id="editButtons">
      <button class="button" id="btnInvert">反色</button>
      <button class="button" id="btnGray">去色</button>
      <button class="button" id="btnRestore">还原</button>
      <button class="button" id="btnDownloadImage">下载图片</button>
    </div>
  </div>

  <!-- 底部 -->
  <div class="footer">
    <a href="/wx/">
      <img class="img" src="https://tool.lu/netcard/" width="100%" height="150" title="关注微信吐槽墙：上墙+留言" alt="" />
    </a>
  </div>

  <!-- 隐藏的 API Key 输入框（如需手输，移除 display:none） -->
  <div class="input-group" style="display:flex; overflow:hidden; width:95%; padding:5px; margin: 0 auto;">
    <input type="text" id="api_key" name="api_key" placeholder="sk-jLgZkKSjwN20PfeHA2eiHAG5HQ0lX8COKCM0UUW7EUSJQ8wN" style="display:none;">
  </div>
</div>

<script>
/* ========= DOM 获取 ========= */
const textarea = document.getElementById("textarea");
const clearBtn = document.getElementById("clear-btn");
const copyBtn = document.getElementById("copy-btn");
const removeDuplicatesBtn = document.getElementById("remove-duplicates-btn");
const openkeyBtn = document.getElementById("openkey-btn");
const response = document.getElementById("response");
const responseWrap = document.getElementById("responseWrap");
const respStatus = document.getElementById("respStatus");
const btnCopyResp = document.getElementById("btnCopyResp");
const btnHideResp = document.getElementById("btnHideResp");

const totalEl = document.getElementById("total");
const chineseEl = document.getElementById("chinese");
const punctuationEl = document.getElementById("punctuation");
const alphabetEl = document.getElementById("alphabet");
const numbersEl = document.getElementById("numbers");
const duplicateEl = document.getElementById("duplicate");

const fileInput = document.getElementById("fileInput");
const intervalInput = document.getElementById("intervalInput");
const btnToB64 = document.getElementById("btnToB64");
const btnFromB64 = document.getElementById("btnFromB64");
const btnFrames = document.getElementById("btnFrames");
const btnClearOutput = document.getElementById("btnClearOutput");

const imageDisplayContainer = document.getElementById("imageDisplayContainer");
const displayedImage = document.getElementById("displayedImage");
const imageTimeLabel = document.getElementById("imageTimeLabel");
const framePager = document.getElementById("framePager");
const prevButton = document.getElementById("prevButton");
const nextButton = document.getElementById("nextButton");
const btnDownloadFrame = document.getElementById("btnDownloadFrame");

const editButtons = document.getElementById("editButtons");
const btnInvert = document.getElementById("btnInvert");
const btnGray = document.getElementById("btnGray");
const btnRestore = document.getElementById("btnRestore");
const btnDownloadImage = document.getElementById("btnDownloadImage");

const dropZone = document.getElementById("dropZone");

/* ========= 状态变量 ========= */
let video = null;
let images = [];
let currentImageIndex = -1;
let currentImage = null;
let currentFilter = "";

/* ========= 工具函数 ========= */
function showResponse(show=true){ responseWrap.style.display = show ? 'block' : 'none'; }
function setRespStatus(text){ respStatus.textContent = text; }
function setBusy(btn, busy=true){
  if(!btn) return;
  btn.disabled = !!busy;
  btn.dataset._text = btn.dataset._text || btn.textContent;
  btn.textContent = busy ? '处理中…' : btn.dataset._text;
}
function debounce(fn, delay=200){
  let t=null;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
}

/* ========= 文本统计 ========= */
function updateStats(){
  const text = textarea.value || "";
  const total = text.length;
  const chinese = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
  const punctuation = (text.match(/[^\u4e00-\u9fa5\w\s]/g) || []).length;
  const alphabet = (text.match(/[a-zA-Z]/g) || []).length;
  const numbers = (text.match(/\d/g) || []).length;
  const duplicates = getDuplicateCount(text);

  totalEl.textContent = `总数：${total}`;
  chineseEl.textContent = `汉字：${chinese}`;
  punctuationEl.textContent = `标点：${punctuation}`;
  alphabetEl.textContent = `字母：${alphabet}`;
  numbersEl.textContent = `数字：${numbers}`;
  duplicateEl.textContent = `重复：${duplicates}`;
}
const updateStatsDebounced = debounce(updateStats, 120);

function getDuplicateCount(text){
  if(!text) return 0;
  const lines = text.split('\n');
  const map = new Map();
  for(const line of lines){
    map.set(line, (map.get(line)||0)+1);
  }
  let dup=0;
  for(const cnt of map.values()){
    if(cnt>1) dup += (cnt-1);
  }
  return dup;
}

function clearTextarea(){
  textarea.value = "";
  showTextStats();
  updateStats();
}

function removeDuplicates(){
  const lines = textarea.value.split('\n');
  const seen = new Set();
  const result = [];
  for(const line of lines){
    if(!seen.has(line)){ seen.add(line); result.push(line); }
  }
  textarea.value = result.join('\n');
  updateStats();
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    alert("已复制到剪贴板");
  }catch(e){
    // 回退
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    alert("已复制到剪贴板");
  }
}

copyBtn.addEventListener("click", ()=>copyToClipboard(textarea.value || textarea.getAttribute("placeholder") || ""));
btnCopyResp.addEventListener("click", ()=>copyToClipboard(response.textContent || ""));
btnHideResp.addEventListener("click", ()=>showResponse(false));

textarea.addEventListener("input", ()=>{ showTextStats(); updateStatsDebounced(); });
clearBtn.addEventListener("click", clearTextarea);
removeDuplicatesBtn.addEventListener("click", removeDuplicates);

/* 显示/隐藏统计与文本按钮（媒体操作隐藏，文本操作显示） */
function hideStatsAndTextGroup(){
  document.getElementById('stats').style.display = 'none';
  document.getElementById('textGroup').style.display = 'none';
}
function showTextStats(){
  document.getElementById('stats').style.display = 'flex';
  document.getElementById('textGroup').style.display = 'flex';
}

/* ========= API 测试 ========= */
async function testAPI(){
  const apiUrl = openkeyBtn.getAttribute("data-api-url");
  const apiKey = document.getElementById('api_key').value.trim() || document.getElementById('api_key').placeholder;
  const originalInput = (textarea.value || "").trim();
  if(!originalInput){ alert("请输入一些文本..."); return; }

  setBusy(openkeyBtn, true);
  showResponse(true);
  setRespStatus("请求中…");
  response.textContent = "请求中…";

  const data = {
    model: "deepseek-chat:free",
    messages: [
      { role: "system", content: "简要回复，字符不超500个。" },
      { role: "user", content: originalInput }
    ],
    temperature: 0.7,
    max_tokens: 1000
  };

  try{
    const res = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify(data)
    });
    if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
    const result = await res.json();
    response.textContent = JSON.stringify(result, null, 2);

    if(result?.choices?.[0]?.message?.content){
      textarea.value = result.choices[0].message.content;
      showTextStats();
      updateStats();
    }
    setRespStatus("完成");
  }catch(err){
    response.textContent = `请求失败: ${err.message}\n请检查API密钥和网络连接。`;
    setRespStatus("失败");
    console.error(err);
  }finally{
    setBusy(openkeyBtn, false);
  }
}
openkeyBtn.addEventListener("click", testAPI);

/* ========= 文件/媒体/Base64 ========= */
function convertToBase64(){
  hideStatsAndTextGroup();
  const file = fileInput.files?.[0];
  if(!file){ alert('请选择一个文件。'); return; }

  const reader = new FileReader();
  reader.onload = e => {
    textarea.value = e.target.result;
    showTextStats(); // 文本结果，显示文本区与统计
    updateStats();
    imageDisplayContainer.style.display = 'none';
    editButtons.style.display = 'none';
  };
  reader.readAsDataURL(file);
}

function parseMimeFromDataURI(dataURI){
  // data:[<mime>][;charset=<charset>][;base64],<encoded-data>
  const m = /^data:([^;,]+)[^,]*,/.exec(dataURI);
  return m ? m[1].trim() : '';
}

function convertFromBase64(){
  hideStatsAndTextGroup();
  const s = (textarea.value || '').trim();
  if(!s){ alert('请输入 Base64 字符串。'); return; }
  if(!s.startsWith('data:')){
    alert('无效的 Base64 数据 URI（需形如 data:...;base64,...）'); return;
  }

  const mime = parseMimeFromDataURI(s);
  if(!mime){ alert('无法解析 MIME 类型'); return; }

  if(mime.startsWith('image/')){
    displayedImage.src = s;
    currentImage = displayedImage;
    currentFilter = '';
    displayedImage.style.filter = currentFilter;

    imageDisplayContainer.style.display = 'block';
    editButtons.style.display = 'block';
    textarea.style.display = 'none';
    setTimeout(()=>displayedImage.scrollIntoView({behavior:'smooth', block:'center'}),50);
  }else if(mime.startsWith('audio/')){
    alert("音频预览请在新窗口中打开或另行处理。");
  }else if(mime.startsWith('video/')){
    alert("视频预览请在新窗口中打开或另行处理。");
  }else{
    alert("该 Base64 内容不属于常见媒体类型，将保留在文本框内。");
    showTextStats();
  }
}

async function extractFrames(){
  hideStatsAndTextGroup();
  const file = fileInput.files?.[0];
  const fps = parseInt(intervalInput.value, 10);
  if(!file || !file.type.startsWith('video/')){ alert('请选择一个视频文件。'); return; }
  if(isNaN(fps) || fps<=0){ alert('请输入有效的帧率。'); return; }

  btnFrames.disabled = true; btnFrames.textContent = '抽帧中…';

  const objectURL = URL.createObjectURL(file);
  video = document.createElement('video');
  video.preload = 'metadata';
  video.src = objectURL;

  video.onloadedmetadata = function(){
    captureFrames(video, fps).then(()=>{
      btnFrames.disabled = false; btnFrames.textContent = '视频帧';
    }).catch(e=>{
      console.error(e);
      alert('抽帧失败：'+e.message);
      btnFrames.disabled = false; btnFrames.textContent = '视频帧';
    });
  };
}

function seekTo(video, t){
  return new Promise(resolve=>{
    const handler = ()=>{ video.removeEventListener('seeked', handler); resolve(); };
    video.addEventListener('seeked', handler, { once:true });
    video.currentTime = Math.min(t, Math.max(0, video.duration - 0.001));
  });
}

async function captureFrames(video, fps){
  images = []; currentImageIndex = -1;
  const frameDuration = 1 / fps;
  const total = Math.floor(video.duration * fps) + 1;
  let currentTime = 0;

  imageDisplayContainer.style.display = 'block';
  editButtons.style.display = 'block';
  textarea.style.display = 'none';

  for(let i=0; i<total; i++){
    await seekTo(video, currentTime);
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    images.push({ url: canvas.toDataURL('image/png'), time: currentTime });
    framePager.textContent = `${i+1} / ${total}`;
    imageTimeLabel.textContent = `进度: ${(currentTime).toFixed(2)}s / ${(video.duration).toFixed(2)}s`;
    currentTime += frameDuration;
    // 让UI有机会刷新
    await new Promise(r=>setTimeout(r, 0));
  }

  if(images.length>0){
    currentImageIndex = 0;
    displayFrame();
    setTimeout(()=>imageDisplayContainer.scrollIntoView({behavior:'smooth', block:'center'}),50);
  }else{
    alert('未能从视频中提取到任何帧。');
  }
}

function displayFrame(){
  if(currentImageIndex<0 || currentImageIndex>=images.length) return;
  const f = images[currentImageIndex];
  displayedImage.src = f.url;
  currentImage = displayedImage;         // 确保编辑按钮作用于当前帧
  displayedImage.style.filter = currentFilter; // 保持滤镜状态
  imageTimeLabel.textContent = `时长: ${f.time.toFixed(2)} 秒`;
  framePager.textContent = `${currentImageIndex+1} / ${images.length}`;
}

function showPreviousImage(){
  if(currentImageIndex>0){ currentImageIndex--; displayFrame(); }
}
function showNextImage(){
  if(currentImageIndex<images.length-1){ currentImageIndex++; displayFrame(); }
}

function downloadFrame(){
  if(currentImageIndex<0 || images.length===0){ alert('请先查看一张图片以下载。'); return; }
  const f = images[currentImageIndex];
  const a = document.createElement('a');
  a.href = f.url;
  a.download = `frame-${String(currentImageIndex+1).padStart(4,'0')}.png`;
  a.click();
}

function downloadImage(){
  if(!currentImage){ alert('请先查看一张图片以下载。'); return; }
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  // 尽可能拿 natural 尺寸；若为空退回显示尺寸
  const w = currentImage.naturalWidth || currentImage.width;
  const h = currentImage.naturalHeight || currentImage.height;
  canvas.width = w; canvas.height = h;
  ctx.filter = currentFilter || 'none';
  ctx.drawImage(currentImage, 0, 0, w, h);
  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/png');
  a.download = 'processed-image.png';
  a.click();
}

function invertColors(){ currentFilter = (currentFilter + ' invert(1)').trim(); if(currentImage) currentImage.style.filter = currentFilter; }
function desaturateImage(){ currentFilter = (currentFilter + ' grayscale(1)').trim(); if(currentImage) currentImage.style.filter = currentFilter; }
function restoreImage(){ currentFilter = ''; if(currentImage) currentImage.style.filter = currentFilter; }

function clearOutput(){
  textarea.value = "";
  updateStats();
  imageDisplayContainer.style.display = 'none';
  editButtons.style.display = 'none';
  images = []; currentImageIndex = -1;
  currentImage = null; currentFilter = '';
  textarea.style.display = 'block';
  showTextStats();
}

/* ========= 事件绑定 ========= */
btnToB64.addEventListener('click', convertToBase64);
btnFromB64.addEventListener('click', convertFromBase64);
btnFrames.addEventListener('click', extractFrames);
btnClearOutput.addEventListener('click', clearOutput);

prevButton.addEventListener('click', showPreviousImage);
nextButton.addEventListener('click', showNextImage);
btnDownloadFrame.addEventListener('click', downloadFrame);

btnInvert.addEventListener('click', invertColors);
btnGray.addEventListener('click', desaturateImage);
btnRestore.addEventListener('click', restoreImage);
btnDownloadImage.addEventListener('click', downloadImage);

/* 键盘切帧 */
window.addEventListener('keydown', (e)=>{
  if(imageDisplayContainer.style.display !== 'block') return;
  if(e.key === 'ArrowLeft'){ showPreviousImage(); }
  else if(e.key === 'ArrowRight'){ showNextImage(); }
});

/* 拖拽上传 */
;['dragenter','dragover','dragleave','drop'].forEach(evt=>{
  dropZone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); });
});
;['dragenter','dragover'].forEach(evt=>{
  dropZone.addEventListener(evt, ()=>dropZone.classList.add('dragover'));
});
;['dragleave','drop'].forEach(evt=>{
  dropZone.addEventListener(evt, ()=>dropZone.classList.remove('dragover'));
});
dropZone.addEventListener('drop', e=>{
  const files = e.dataTransfer.files;
  if(files && files.length){ fileInput.files = files; }
});

/* 初始化 */
updateStats();
showTextStats();
</script>
</body>
</html>
